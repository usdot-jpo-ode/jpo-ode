package us.dot.its.jpo.ode.uper;


import static org.junit.jupiter.api.Assertions.assertArrayEquals;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertThrows;

import java.util.HashMap;
import org.apache.tomcat.util.buf.HexUtils;
import org.junit.jupiter.api.Test;
import us.dot.its.jpo.ode.model.OdeAsn1Payload;

class UperUtilTest {

  @Test
  void testStripDot2Header() throws StartFlagNotFoundException {
    String testHexString = "1011001400";
    String testPayloadStartFlag = "0014";
    String expectedValue = "001400";
    assertEquals(expectedValue, UperUtil.stripDot2Header(testHexString, testPayloadStartFlag));
  }

  @Test
  void testStripDot2HeaderBadData() {
    String testHexString = "0014";
    String testPayloadStartFlag = "0015";
    assertThrows(StartFlagNotFoundException.class,
        () -> UperUtil.stripDot2Header(testHexString, testPayloadStartFlag));
  }

  @Test
  void testStripDot3Header() {
    byte[] testPacket = {0x10, 0x20, 0x00, 0x1f, 0x00};
    byte[] testExpected = {0x00, 0x1f, 0x00};
    HashMap<String, String> testMsgStartFlag = new HashMap<>();
    testMsgStartFlag.put("TIM", "001f");
    byte[] testResult = UperUtil.stripDot3Header(testPacket, testMsgStartFlag);
    assertArrayEquals(testExpected, testResult);
  }

  @Test
  void testStripDot3HeaderWithDot2StartIndex() {
    byte[] testPacket = {0x0, 0x01, 0x03, (byte) 0x81, 0x00, 0x00, 0x1f, 0x00};
    byte[] testExpected = {0x03, (byte) 0x81, 0x00, 0x00, 0x1f, 0x00};
    HashMap<String, String> testMsgStartFlag = new HashMap<>();
    testMsgStartFlag.put("TIM", "001f");
    byte[] testResult = UperUtil.stripDot3Header(testPacket, testMsgStartFlag);
    assertArrayEquals(testExpected, testResult);
  }

  @Test
  void testStripDot3HeaderString() {
    String testPacketString = "0102001f00";
    String testExpectedString = "001f00";
    String testMsgStartFlag = "001f";
    assertEquals(testExpectedString, UperUtil.stripDot3Header(testPacketString, testMsgStartFlag));
  }

  @Test
  void testStripDot3HeaderStringWithDot2StartIndex() {
    String testPacketString = "0001038100001f00";
    String testExpectedString = "038100001f00";
    String testMsgStartFlag = "001f";
    assertEquals(testExpectedString, UperUtil.stripDot3Header(testPacketString, testMsgStartFlag));
  }

  @Test
  void testDetermineMessageType() {
    String mapHexString =
        "0012839338023000205E96094D40DF4C2CA626C8516E02DC3C2010640000000289E01C009F603F42E88039900000000A41107B027D80FD0A4200C6400000002973021C09F603DE0C16029200000080002A8A008D027D98FEE805404FB0E1085F60588200028096021200000080002AA0007D027D98FE9802E04FB1200C214456228000A02B1240005022C03240000020000D56B40BC04FB35FF655E2C09F623FB81C835FEC0DB240A0A2BFF4AEBF82C660000804B0089000000800025670034013ECD7FB9578E027D9AFF883C4E050515FFA567A41635000040258024800000400012B8F81F409F663FAC094013ECD7FC83DDB02829AFFA480BC04FB02C6E0000804B09C5000000200035EA98A9604F60DA6C7C113D505C35FFE941D409F65C05034C050500C9880004409BC800000006D2BD3CEC813C40CDE062C1FD400000200008791EA3DB3CF380A009F666F05005813D80FFE0A0588C00040092106A00000000BC75CAC009F66DB54C04A813D80A100801241ED40000000078EBAE3B6DA7A008809E2050904008811F100000000BC72389009F60ECA8002049C400000002F1B2CA3027D93A71FA813EC204BC400000002F1B2B34027B0397608880CD10000000039B8E1A51036820505080D51000000003A7461ED1036760505080DD1000000003B2F62311006260505160BCA00000080002B785E2A80A0A6C028DE728145037F1F9E456488000202B2540001022C1894000001000057058C5B81414D806DBCD4028A18F4DF23A050502C8D0000404B05A5000000800035B6471BC05053602431F380A2864087BDB0141458064AB0D6C00053FC013EC0B0680006012C15940000020000D6C06C6581414D807FB972028A1901D78DC050536020EC1800A0A6C039D639813D80B0780006012C1494000002000096AB8C6581414D8062BE32028A1B01417E04050A360172D77009E2058440003009409C200000040006B3486A480A0A1CAB7134C8117DCC02879B018FAE2C050F3601CED54809E21012720000000067FBAD0007E7E84045C80000000100661580958004041C8000000019F3658401CDFA2C0D64000002000144016C02C36DDFFF0282984ACC1EE05052C36F0AC02828669D82DA8F821480A0A10F140002C8E0001004B03190000008000519FD190C43B2E0066108B08401428C342A0CE02828258A0604A6BE959AEE0E6050502C920001004B02D90000008000459FA164404FB30A8580A00A14619C306701414C32CE10E02829659081F814141029030164B0000802E8000802000035FDB1D84C09EC6C003BA14814140B0540003012C187400040080011B13F6EDB804F115FA6DFC10AFC94FC6A57EE07DCE2BFA7BED3B5FFCD72E80A1E018C900008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
    OdeAsn1Payload mapPayload = new OdeAsn1Payload(HexUtils.fromHexString(mapHexString));
    assertEquals("MAP", UperUtil.determineMessageType(mapPayload));

    String timHexString =
        "001F79201000000000012AA366D080729B8987D859717EE22001FFFE4FD0011589D828007E537130FB0B2E2FDC440001F46FFFF002B8B2E46E926E27CE6813D862CB90EDC9B89E11CE2CB8E98F9B89BCC4050518B2E365B66E26AE3B8B2E291A66E2591D8141462CB873969B89396C62CB86AFE9B89208E00000131560018300023E43A6A1351800023E4700EFC51881010100030180C620FB90CAAD3B9C5082080E1DDC905E10168E396921000325A0D73B83279C83010180034801090001260001808001838005008001F0408001828005008001304000041020407E800320409780050080012040000320409900018780032040958005000001E0408183E7139D7B70987019B526B8A950052F5C011D3C4B992143E885C71F95DA6071658082346CC03A50D66801F65288C30AB39673D0494536C559047E457AD291C99C20A7FB1244363E993EE3EE98C78742609340541DA01545A0F7339C26A527903576D30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
    OdeAsn1Payload timPayload = new OdeAsn1Payload(HexUtils.fromHexString(timHexString));
    assertEquals("TIM", UperUtil.determineMessageType(timPayload));
  }
}
